---
# This playbook deploys and configures the image builder software on RHEL 7 and RHEL 8
#

- name: Deploying Image Builder
  hosts: all
  remote_user: root
  gather_facts: true
  
  vars: 
    composer_main_pkg: "osbuild-composer"

  tasks:
  
  # packages are available in base repos.
  # for completeness, we would check registration and repository configuration
  # but we aren't going to as this system will always be installed by
  # Satellite
  - name: ensure repos for RHEL7, RHEL8 they are in the base repos
    rhsm_repository:
      name: rhel-7-server-extras-rpms
    when: ansible_distribution_major_version == "7"

  - name: determine the builder application
    set_fact:
      composer_main_pkg: "lorax-composer"
    when: ansible_distribution_major_version == "7"

  - name: install packages
    yum:
      name:
      - "{{ composer_main_pkg }}"
      - composer-cli 
      - cockpit
      - cockpit-composer 
      - bash-completion
      state: latest
    

  - name: enable composer socket
    service:
      name: "{{ composer_main_pkg }}.socket"
      state: started
      enabled: true

  - name: enable cockpit socket
    service:
      name: cockpit.socket
      state: started
      enabled: true

  - name: configure firewall
    firewalld:
      service: cockpit
      state: enabled
      immediate: true
      permanent: true

  - name: configure environment
    shell: "source  /etc/bash_completion.d/composer-cli"

  - name: update for repository configuration
    include_tasks: repo_config.yml
    
    